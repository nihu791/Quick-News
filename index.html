<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick News - AI Enhanced</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
        }
        /* Style for the news card hover effect */
        .news-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        /* Simple loading spinner animation */
        .spinner {
            border-color: #2dd4bf; /* Teal color */
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Styles for the modal */
        #gemini-modal-content {
            white-space: pre-wrap; /* Preserve line breaks in Gemini response */
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-teal-400">Quick News</h1>
            <p class="text-gray-400 mt-2">Your AI-powered daily digest of world events.</p>
        </header>

        <!-- Search and AI Features -->
        <div class="mb-8 max-w-2xl mx-auto flex flex-col sm:flex-row gap-4">
            <input 
                type="text" 
                id="search-input"
                placeholder="Search for topics..."
                class="flex-grow px-4 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors"
            >
            <button id="briefing-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg transition-colors flex items-center justify-center gap-2">
                ✨ Get Today's Briefing
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-10 hidden">
            <div class="spinner w-12 h-12 rounded-full border-4 border-t-4 border-gray-200 mx-auto"></div>
            <p class="mt-4 text-gray-400">Fetching the latest stories...</p>
        </div>
        
        <!-- Error Message Container -->
        <div id="error-message" class="text-center py-10 hidden">
             <p class="text-red-400 text-lg"></p>
        </div>

        <!-- News Articles Grid -->
        <main id="news-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            <!-- News articles will be dynamically inserted here -->
        </main>
    </div>

    <!-- Template for a single news card -->
    <template id="news-card-template">
        <div class="news-card bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col">
            <img src="https://placehold.co/600x400/1f2937/7dd3fc?text=News" alt="News Image" class="w-full h-48 object-cover news-image">
            <div class="p-5 flex flex-col flex-grow">
                <h2 class="text-xl font-bold text-gray-100 mb-2 news-title flex-grow">Article Title</h2>
                <p class="text-gray-400 text-sm mb-4 news-description">Article description goes here. This is a snippet of the full article content.</p>
                <div class="mt-auto flex flex-wrap gap-2">
                    <a href="#" target="_blank" rel="noopener noreferrer" class="news-link inline-block bg-teal-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-teal-700 transition-colors">Read More</a>
                    <button class="summarize-btn inline-block bg-purple-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">✨ Summarize</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Gemini Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 id="gemini-modal-title" class="text-2xl font-bold text-teal-400">AI-Generated Content</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="gemini-modal-loader" class="text-center hidden">
                    <div class="spinner w-10 h-10 rounded-full border-4 mx-auto"></div>
                    <p class="mt-3 text-gray-400">Gemini is thinking...</p>
                </div>
                <div id="gemini-modal-content" class="text-gray-300"></div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const NEWS_API_KEY = 'f623d9a025814ba4b157e6a43fd07a19';
            const NEWS_BASE_URL = 'https://newsapi.org/v2/everything';
            const GEMINI_API_KEY = ""; // No key needed, will be provided by the environment
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            // DOM Elements
            const newsContainer = document.getElementById('news-container');
            const searchInput = document.getElementById('search-input');
            const loadingIndicator = document.getElementById('loading');
            const errorMessageContainer = document.getElementById('error-message');
            const cardTemplate = document.getElementById('news-card-template');
            const briefingButton = document.getElementById('briefing-button');
            const modal = document.getElementById('gemini-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('gemini-modal-title');
            const modalContent = document.getElementById('gemini-modal-content');
            const modalLoader = document.getElementById('gemini-modal-loader');

            let searchTimeout;
            let currentArticles = [];

            // --- API FUNCTIONS ---

            async function fetchNews(query) {
                showLoading(true);
                clearContent();
                
                // Switching back to the allorigins proxy to resolve fetch errors.
                const PROXY_URL = 'https://api.allorigins.win/raw?url=';
                const requestUrl = `${NEWS_BASE_URL}?q=${encodeURIComponent(query)}&sortBy=publishedAt&language=en&apiKey=${NEWS_API_KEY}`;
                const url = `${PROXY_URL}${encodeURIComponent(requestUrl)}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`CORS proxy error! Status: ${response.status}`);
                    const data = await response.json();
                    if (data.status === 'error') throw new Error(data.message);
                    
                    currentArticles = data.articles.filter(a => a.title && a.description);
                    displayNews(currentArticles);
                } catch (error) {
                    console.error("Error fetching news:", error);
                    displayError(`${error.message || 'Failed to fetch news. The proxy may be down.'}`);
                } finally {
                    showLoading(false);
                }
            }
            
            async function callGeminiWithRetries(prompt, maxRetries = 3) {
                let attempt = 0;
                while (attempt < maxRetries) {
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        const response = await fetch(GEMINI_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                             const errorBody = await response.text();
                             console.error(`Gemini API Error (Status ${response.status}):`, errorBody);
                             throw new Error(`Gemini API request failed with status ${response.status}`);
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) return text;
                        
                        throw new Error("Invalid response structure from Gemini API.");

                    } catch (error) {
                        console.error(`Gemini API call attempt ${attempt + 1} failed:`, error);
                        attempt++;
                        if (attempt >= maxRetries) throw error;
                        await new Promise(res => setTimeout(res, 1000 * Math.pow(2, attempt))); // Exponential backoff
                    }
                }
            }

            // --- UI FUNCTIONS ---

            function displayNews(articles) {
                if (!articles || articles.length === 0) {
                    displayError("No articles found for your search. Please try another topic.");
                    briefingButton.disabled = true;
                    return;
                }
                briefingButton.disabled = false;

                articles.forEach((article, index) => {
                    const card = document.importNode(cardTemplate.content, true);
                    const cardElement = card.querySelector('.news-card');
                    cardElement.dataset.index = index;
                    
                    const image = card.querySelector('.news-image');
                    const title = card.querySelector('.news-title');
                    const description = card.querySelector('.news-description');
                    const link = card.querySelector('.news-link');

                    image.src = article.urlToImage || 'https://placehold.co/600x400/1f2937/7dd3fc?text=Image+Not+Available';
                    image.alt = article.title;
                    image.onerror = () => { image.src = 'https://placehold.co/600x400/1f2937/7dd3fc?text=Image+Error'; };
                    
                    title.textContent = article.title;
                    description.textContent = article.description;
                    link.href = article.url;

                    newsContainer.appendChild(card);
                });
            }
            
            function clearContent() {
                newsContainer.innerHTML = '';
                errorMessageContainer.classList.add('hidden');
                errorMessageContainer.querySelector('p').textContent = '';
                currentArticles = [];
                briefingButton.disabled = true;
            }

            function displayError(message) {
                errorMessageContainer.querySelector('p').textContent = message;
                errorMessageContainer.classList.remove('hidden');
            }

            function showLoading(isLoading) {
                loadingIndicator.classList.toggle('hidden', !isLoading);
            }

            // --- MODAL FUNCTIONS ---

            function openModal(title) {
                modalTitle.textContent = title;
                modalContent.innerHTML = '';
                modalLoader.classList.remove('hidden');
                modal.classList.remove('hidden');
            }

            function closeModal() {
                modal.classList.add('hidden');
            }
            
            function setModalContent(content, isError = false) {
                modalLoader.classList.add('hidden');
                modalContent.textContent = content;
                if (isError) {
                    modalContent.classList.add('text-red-400');
                } else {
                    modalContent.classList.remove('text-red-400');
                }
            }
            
            // --- EVENT HANDLERS ---

            async function handleBriefingClick() {
                if (currentArticles.length === 0) return;
                openModal("✨ Today's Briefing");

                const articlesText = currentArticles
                    .slice(0, 20) // Limit to first 20 articles to avoid huge prompts
                    .map(a => `Title: ${a.title}\nDescription: ${a.description}`)
                    .join('\n\n');
                
                const prompt = `You are a news analyst. Based on the following article headlines and descriptions, provide a concise and coherent news briefing. Group related stories and provide a high-level overview.\n\n${articlesText}`;

                try {
                    const briefing = await callGeminiWithRetries(prompt);
                    setModalContent(briefing);
                } catch (error) {
                    setModalContent("Sorry, I couldn't generate the briefing at this moment. Please try again later.", true);
                }
            }
            
            async function handleSummarizeClick(e) {
                if (!e.target.classList.contains('summarize-btn')) return;

                const card = e.target.closest('.news-card');
                const articleIndex = card.dataset.index;
                const article = currentArticles[articleIndex];
                if (!article) return;

                openModal(`✨ Summary: ${article.title}`);
                const prompt = `Please provide a concise summary of the following news article:\n\nTitle: ${article.title}\n\nDescription: ${article.description}`;

                try {
                    const summary = await callGeminiWithRetries(prompt);
                    setModalContent(summary);
                } catch (error) {
                     setModalContent("Sorry, I couldn't generate the summary at this moment. Please try again later.", true);
                }
            }

            // --- EVENT LISTENERS ---

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                searchTimeout = setTimeout(() => {
                    fetchNews(query || 'world headlines');
                }, 500);
            });
            
            briefingButton.addEventListener('click', handleBriefingClick);
            newsContainer.addEventListener('click', handleSummarizeClick);
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(); // Close if clicking on backdrop
            });

            // --- INITIAL LOAD ---
            fetchNews('latest technology');
        });
    </script>

</body>
</html>
